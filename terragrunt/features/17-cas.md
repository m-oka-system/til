# Content Addressable Store / CAS（コンテンツアドレッサブルストア）

> 公式: https://terragrunt.gruntwork.io/docs/features/cas/

## 概要

**CAS** は、複数の設定間でコンテンツを重複排除する実験的機能です。冗長な Git リポジトリダウンロードを排除することで、カタログクローンと OpenTofu/Terraform ソースクローンの両方を高速化します。

> CAS を使用するには、Terragrunt 設定で `cas` 実験を有効にする必要があります。

## 使用例

### カタログ設定

```hcl
catalog {
  urls = [
    "git@github.com:acme/modules.git"
  ]
}
```

### Terraform ソース設定

```hcl
terraform {
  source = "git@github.com:acme/infrastructure-modules.git//vpc?ref=v1.0.0"
}
```

CAS 有効時、Git リポジトリのクローン時に自動的に CAS を活用します。

## ストレージ場所

```
~/.cache/terragrunt/cas
```

このディレクトリはいつでも安全に削除可能です（Terragrunt が自動再生成）。ただし**部分的な削除は避けてください** — 不完全なキャッシュエントリが予期しない動作を引き起こす可能性があります。

## 技術的な仕組み

### コンテンツアドレッシング

Git の SHA1 ハッシュスキームを使用してすべてのオブジェクトを一意に識別:
- 同一コンテンツは同じハッシュ値を受け取る
- コミットハッシュは常に同じコンテンツを表現
- ハッシュプレフィックス（先頭2文字）でストレージを分割

### ディレクトリ構造

```
~/.cache/terragrunt/cas/store/
├── ab/
│   ├── abc123…xyz       (blob)
│   ├── abc123…xyz.lock  (lock file)
│   └── abd456…xyz       (tree)
└── cd/
    ├── cd7890…xyz       (blob)
    └── cd7890…xyz.lock  (lock file)
```

ハッシュプレフィックスによる分割で、単一ディレクトリに大量のファイルが集中することによるパフォーマンス低下を防ぎます。

### クローン操作

#### コールドクローン（初回取得）

```
Git リファレンス → コミットハッシュに解決
    ↓
CAS にツリーが見つからない
    ↓
リポジトリを一時ディレクトリにクローン
    ↓
必要な blob と tree を CAS に抽出
    ↓
ターゲットディレクトリにハードリンクを作成
```

#### ウォームクローン（キャッシュ済み取得）

```
Git リファレンス → コミットハッシュに解決
    ↓
CAS でコンテンツの存在を確認
    ↓
CAS からツリー構造を直接読み取り
    ↓
キャッシュからターゲットにハードリンクを作成
```

### 重複排除戦略

**ハードリンク**により、複数のファイルが同一の物理ディスク領域を共有します。ファイルシステム境界や OS の制限でハードリンクが失敗した場合は、自動的にコピーにフォールバックします。

## パフォーマンス上の利点

- **後続クローンの高速化** — キャッシュ済みコンテンツではネットワークダウンロードと Git 操作が完全にスキップ
- **ディスク使用量の削減** — ハードリンクにより inode を共有し、重複ファイルは使用回数に関係なく1回分のディスク領域のみ消費
