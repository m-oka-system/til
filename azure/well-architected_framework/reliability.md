# 信頼性

## 設計原則

- クラウドでは障害が発生する前提で考える
- 単一コンポーネントの影響が最小限になるよう設計する
- ビジネス要件（SLA）を元に設計する
- 問題を検出できるようアプリの正常性を監視する
- テストやデプロイの自動化を推進する
- 自動スケールを実装する

## デザイン

### 要件

- 許容できるダウンタイムを決定する
- 災害時に許容できるデータ損失の量を決定する
- システム内の個々のコンポーネントの SLA を理解する（複合 SLA を計算する）
- アプリケーションの可用性を監視・測定する
  - 平均故障間隔 (MTBF)： システムが正常に動いている時間の平均
  - 平均復旧時間 (MTTR)： システムの障害時に復旧にかかる時間の平均
- 障害時の回復目標を決定する
  - 復旧時間目標（RTO）： 障害が発生後、アプリケーションが利用できない最大許容時間（復旧にどれくらいかかるか）
  - 復旧時点目標（RPO）： 障害時に許容できるデータ損失の最大期間（いつ時点に戻るか）
- SKU によってサポートされる機能や SLA が異なる点に注意する
- 要件に応じてゾーン冗長、クロスリージョン構成を検討する

## アプリケーションの設計

- 基本的にゾーン冗長前提でアプリを設計する
  - コンポーネント間で非常に高い低レイテンシが要求される場合は隣接配置を検討する
- PaaS（マネージドサービス）を利用する
- 障害の影響を受けた場合でも動作するように設計する（リトライ処理など）
- スケールアウトするように設計する

## 回復性と依存関係

- 故障モード解析（FMA）で障害ポイントを特定する
- 単一障害店を排除する
- アプリの依存関係を宣言しリストを管理する（例：Gemfile）

## データ管理

- SQL Database, Cosmos DB などの PaaS サービスは自動バックアップの機能がある
- SQL Database では geo 冗長のリカバリオプションが提供されている
  - ジオ・リストア（ペアリージョンのバックアップからリストア）
  - アクティブ・ジオ・レプリケーション（手動フェールオーバー）
  - 自動フェールオーバーグループ
- Azure Storage は自動レプリカの機能がある
  - 誤削除を防ぐことはできないのでスナップショットの取得や AzCopy でのコピーを検討する

## ビジネス指標

- SLA, SLI, SLO などの可用性目標を定義する
- 可用性目標について顧客から同意を得て文書化する
- 重要度の低いコンポーネントはパフォーマンスや可用性の低い SKU を選択することでコスト削減につながる

## テスト

### 回復力テスト

- 定期的にテストを行い、既存の閾値、目標、前提条件を検証する
- 可能な限りテストを自動化する
- テスト環境と本番環境の両方でテストを実施する

### バックアップとリカバリ

- 災害復旧計画を作成し、定期的にテストする
- フェイルオーバーとフェイルバックのステップとプロセスを自動化する
- バックアップ戦略
  - 再デプロイ
  - アクティブ/パッシブ
  - アクティブ/アクティブ

### アプリケーションのエラー処理

- リトライロジックを実装する
  - 再試行ポリシーは、アプリケーションのビジネス要件と障害の性質に合わせて調整する
  - 何度もリトライしてアプリのスループットに影響を与えるよりも高速に失敗したほうが良い場合もある
  - バッチアプリケーションの場合は、リトライの回数を増やし、リトライ間の遅延を指数関数的に増加させる
  - リトライ処理が冪等かどうか検討する
- サーキットブレーカーを実装する
  - 依存サービスに負担をかけないようにする
- 適切なリクエスト・タイムアウトを設定する
- 負荷分散サービスのヘルスプローブを設定し、テストする
  - Front Door / Traffic Manager の場合、別リージョンにフェールオーバーするかどうかを決定する
  - Load Balancer の場合、バックエンドの VM をローテーションから外すかどうかを決定する

### カオスエンジニアリング

- 障害を意図的に注入してテストを行う（Azure Chaos Studio）
  - Shift Left: 開発段階の早いフェーズからテストを行う
  - Shift Right: 実際の顧客負荷がある実稼働前、または、本番環境でテストを行う

## モニタリング

### アプリケーションの健全性

- Azure Service Health を使用して Azure サービスとリージョンの正常性を監視する
- Azure Resource Health を使用して個々のリソースの正常性を監視する
- ダッシュボードを使用して監視グラフを組み合わせたビューを作成する
- サブスクリプションのクォータ制限に達しないように監視する
- 重要なコンポーネントのログと主要なメトリックを収集する

### 正常性のモデリング

- 正常な状態と異常な状態を定義する
- アプリケーションのログ
  - セマンティック ログ( 構造化ログ)を使用する（Log Analytics 推奨）
  - サービス境界でのイベントを記録する
  - 非同期ロギングを使用する
  - アプリケーションのログと監査ログを分離する
